<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Automation Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Test Automation Agent</span>
                </div>
                <div id="agentStatus" class="status-indicator status-inactive">
                    –ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="dashboard">
            <div>
                <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–º</h2>
                    </div>
                    
                    <div class="actions" style="margin-top: 0;">
                        <button id="startBtn" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                            </svg>
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç
                        </button>
                        <button id="stopBtn" class="btn btn-danger" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="6" y="6" width="12" height="12" fill="currentColor"/>
                            </svg>
                            –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≥–µ–Ω—Ç
                        </button>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2 class="card-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞</h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="modelPath">–ü—É—Ç—å –∫ –º–æ–¥–µ–ª–∏ –ò–ò</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="modelPath" class="file-input" accept=".gguf">
                            <label for="modelPath" class="file-input-label">
                                –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏ (.gguf)
                            </label>
                        </div>
                        <div id="modelFileName" class="file-name"></div>
                        <div style="margin-top: 0.5rem;">
                            <label class="form-label" for="modelPathInput">–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å:</label>
                            <input type="text" id="modelPathInput" class="form-input" 
                                   placeholder="C:\Users\apors\AI\AFT_Agent\models\yandex-gpt.gguf"
                                   value="C:\Users\apors\AI\AFT_Agent\models\yandex-gpt.gguf">
                        </div>
                        <div class="form-hint">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª –∏–ª–∏ —É–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ñ–∞–π–ª—É</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="scenarioRepo">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</label>
                        <input type="text" id="scenarioRepo" class="form-input" placeholder="username/scenario-repo" value="johny19844/scenario">
                        <div class="form-hint">–§–æ—Ä–º–∞—Ç: username/repository-name</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="aftRepo">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π AFT</label>
                        <input type="text" id="aftRepo" class="form-input" placeholder="username/aft-repo" value="johny19844/AFT">
                        <div class="form-hint">–§–æ—Ä–º–∞—Ç: username/repository-name</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="scanInterval">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)</label>
                        <input type="number" id="scanInterval" class="form-input" value="300" min="30">
                    </div>
                </div>
            </div>
            
            <div>
                <!-- –ë–ª–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-header">
                            <span class="progress-title">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-details">
                            <div class="progress-step" id="stepScanning">
                                <span>üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                            </div>
                            <div class="progress-step" id="stepProcessing">
                                <span>‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞</span>
                            </div>
                            <div class="progress-step" id="stepGenerating">
                                <span>ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</span>
                            </div>
                            <div class="progress-step" id="stepUploading">
                                <span>üì§ –ó–∞–≥—Ä—É–∑–∫–∞</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card info" onclick="showTestsModal('all')">
                            <div id="totalFiles" class="stat-value info">0</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</div>
                        </div>
                        <div class="stat-card success" onclick="showTestsModal('success')">
                            <div id="successTests" class="stat-value success">0</div>
                            <div class="stat-label">–£—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã</div>
                        </div>
                        <div class="stat-card error" onclick="showTestsModal('failed')">
                            <div id="failedTests" class="stat-value error">0</div>
                            <div class="stat-label">–û—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                        </div>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ –∂—É—Ä–Ω–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2 class="card-title">–ñ—É—Ä–Ω–∞–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
                    </div>
                    
                    <div id="activityLog" class="activity-log">
                        <div class="log-entry">
                            <span class="log-timestamp">[12:00:00]</span>
                            <span class="log-info">–ê–≥–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞.</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button id="clearLogBtn" class="btn btn-secondary">
                            –û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª
                        </button>
                        <button id="exportLogBtn" class="btn btn-secondary">
                            –≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="testsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">–¢–µ—Å—Ç—ã</h3>
                <button class="modal-close" onclick="closeTestsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const agentStatus = document.getElementById('agentStatus');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const modelPathInput = document.getElementById('modelPath');
        const modelPathTextInput = document.getElementById('modelPathInput');
        const modelFileName = document.getElementById('modelFileName');
        const scenarioRepoInput = document.getElementById('scenarioRepo');
        const aftRepoInput = document.getElementById('aftRepo');
        const scanIntervalInput = document.getElementById('scanInterval');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        const activityLog = document.getElementById('activityLog');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const exportLogBtn = document.getElementById('exportLogBtn');

        // –ê–¥—Ä–µ—Å –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        const SERVER_URL = window.location.origin;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
        let agentState = {
            active: false,
            totalFiles: 0,
            successTests: 0,
            failedTests: 0,
            currentProgress: 0,
            testResults: {
                success: [],
                failed: []
            },
            currentStep: 'idle'
        };

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ä–æ—Å–æ–º
        let statusPollInterval = null;
        let logUpdateInterval = null;

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º –∑–∞–ø—É—Å–∫–µ
        function resetProgress() {
            agentState.totalFiles = 0;
            agentState.successTests = 0;
            agentState.failedTests = 0;
            agentState.currentProgress = 0;
            agentState.testResults = { success: [], failed: [] };
            agentState.currentStep = 'idle';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–≥–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const steps = ['scanning', 'processing', 'generating', 'uploading'];
            steps.forEach(step => {
                const stepElement = document.getElementById(`step${step.charAt(0).toUpperCase() + step.slice(1)}`);
                if (stepElement) {
                    stepElement.className = 'progress-step pending';
                    let icon = '‚è≥';
                    if (step === 'scanning') icon = 'üîç';
                    if (step === 'processing') icon = '‚öôÔ∏è';
                    if (step === 'generating') icon = 'ü§ñ';
                    if (step === 'uploading') icon = 'üì§';
                    
                    let text = '';
                    switch(step) {
                        case 'scanning': text = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'; break;
                        case 'processing': text = '–û–±—Ä–∞–±–æ—Ç–∫–∞'; break;
                        case 'generating': text = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è'; break;
                        case 'uploading': text = '–ó–∞–≥—Ä—É–∑–∫–∞'; break;
                    }
                    
                    stepElement.innerHTML = `<span>${icon} ${text}</span>`;
                }
            });
            
            updateUI();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        function showTestsModal(type) {
            const modal = document.getElementById('testsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            let title = '';
            let tests = [];
            
            switch(type) {
                case 'success':
                    title = '–£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã';
                    tests = agentState.testResults.success;
                    break;
                case 'failed':
                    title = '–¢–µ—Å—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                    tests = agentState.testResults.failed;
                    break;
                case 'all':
                    title = '–í—Å–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã';
                    tests = [...agentState.testResults.success, ...agentState.testResults.failed];
                    break;
            }
            
            modalTitle.textContent = title;
            
            if (tests.length === 0) {
                modalContent.innerHTML = `
                    <div class="empty-state">
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                        <small>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≥–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤</small>
                    </div>
                `;
            } else {
                let html = `<ul class="test-list">`;
                
                tests.forEach(test => {
                    const statusClass = test.status === 'success' ? 'success' : 'error';
                    const statusText = test.status === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞';
                    const timestamp = test.timestamp ? new Date(test.timestamp).toLocaleTimeString() : '--:--:--';
                    
                    html += `
                        <li class="test-item ${statusClass}">
                            <div style="flex-grow: 1;">
                                <div class="test-name">${test.filename}</div>
                                <div class="test-details">
                                    –°—Ü–µ–Ω–∞—Ä–∏–π: ${test.scenarioFile}<br>
                                    –í—Ä–µ–º—è: ${timestamp}
                                    ${test.error ? `<br>–û—à–∏–±–∫–∞: ${test.error}` : ''}
                                </div>
                            </div>
                            <span class="test-status ${statusClass}">${statusText}</span>
                        </li>
                    `;
                });
                
                html += `</ul>`;
                modalContent.innerHTML = html;
            }
            
            modal.style.display = 'block';
        }

        function closeTestsModal() {
            const modal = document.getElementById('testsModal');
            modal.style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞–≥–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgressStep(step, status) {
            const stepElement = document.getElementById(`step${step.charAt(0).toUpperCase() + step.slice(1)}`);
            if (stepElement) {
                stepElement.className = `progress-step ${status}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Ç–∞—Ç—É—Å–∞
                let icon = '‚è≥';
                if (status === 'completed') icon = '‚úÖ';
                if (status === 'failed') icon = '‚ùå';
                
                stepElement.innerHTML = `<span>${icon} ${stepElement.textContent.replace(/[‚è≥‚úÖ‚ùåüîç‚öôÔ∏èü§ñüì§]/g, '').trim()}</span>`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤ –∏ —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatsFromLogs(logs) {
            if (!logs) return;
            
            logs.forEach(log => {
                const message = log.raw_message || log.message;
                const messageLower = message.toLowerCase();
                
                // –≠—Ç–∞–ø –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø
                if (messageLower.includes('monitoring:') || 
                    messageLower.includes('scanning repository') ||
                    messageLower.includes('file modified:') ||
                    messageLower.includes('found') && messageLower.includes('changed/new files')) {
                    agentState.currentStep = 'scanning';
                    updateProgressStep('scanning', 'completed');
                }
                
                // –≠—Ç–∞–ø –û–ë–†–ê–ë–û–¢–ö–ò
                if (messageLower.includes('processing scenario') ||
                    messageLower.includes('downloading scenario file') ||
                    messageLower.includes('downloaded successfully') ||
                    messageLower.includes('processing file')) {
                    agentState.currentStep = 'processing';
                    updateProgressStep('processing', 'completed');
                    
                    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è
                    if (messageLower.includes('file modified:') || messageLower.includes('processing file')) {
                        agentState.totalFiles++;
                    }
                }
                
                // –≠—Ç–∞–ø –ì–ï–ù–ï–†–ê–¶–ò–ò
                if (messageLower.includes('generating java test code for') ||
                    messageLower.includes('generated valid code for') ||
                    messageLower.includes('analyze_scenario') ||
                    messageLower.includes('model output')) {
                    agentState.currentStep = 'generating';
                    updateProgressStep('generating', 'completed');
                    
                    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞
                    if (messageLower.includes('generated valid code for') && !messageLower.includes('error')) {
                        const testMatch = message.match(/for\s+([A-Za-z0-9_]+)/);
                        if (testMatch) {
                            const testName = testMatch[1] + 'Test.java';
                            const scenarioMatch = message.match(/file:\s+([^\s,.]+)/i);
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Ç–µ—Å—Ç–∞
                            const existingTest = agentState.testResults.success.find(t => t.filename === testName);
                            if (!existingTest) {
                                agentState.testResults.success.push({
                                    filename: testName,
                                    scenarioFile: scenarioMatch ? scenarioMatch[1] : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                                    status: 'success',
                                    timestamp: new Date().toISOString()
                                });
                                agentState.successTests++;
                            }
                        }
                    }
                }
                
                // –≠—Ç–∞–ø –ó–ê–ì–†–£–ó–ö–ò
                if (messageLower.includes('pushing to aft repository') ||
                    messageLower.includes('updated file') ||
                    messageLower.includes('commit:') ||
                    messageLower.includes('cleaned up temporary files') ||
                    messageLower.includes('scenario') && messageLower.includes('processed successfully') ||
                    messageLower.includes('successfully processed') ||
                    messageLower.includes('saved scenario file status')) {
                    agentState.currentStep = 'uploading';
                    updateProgressStep('uploading', 'completed');
                }
                
                // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                if ((messageLower.includes('error') || messageLower.includes('failed')) && 
                    (messageLower.includes('test') || messageLower.includes('–≥–µ–Ω–µ—Ä–∞—Ü') || messageLower.includes('generat'))) {
                    
                    const scenarioMatch = message.match(/file[:\s]+([^\s,.]+)/i);
                    if (scenarioMatch) {
                        const scenarioFile = scenarioMatch[1];
                        const errorMsg = message.length > 100 ? message.substring(0, 100) + '...' : message;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –æ—à–∏–±–∫–∏
                        const existingError = agentState.testResults.failed.find(t => t.scenarioFile === scenarioFile);
                        if (!existingError) {
                            agentState.testResults.failed.push({
                                filename: `–û—à–∏–±–∫–∞: ${scenarioFile}`,
                                scenarioFile: scenarioFile,
                                status: 'failed',
                                error: errorMsg,
                                timestamp: new Date().toISOString()
                            });
                            agentState.failedTests++;
                        }
                    }
                }
                
                // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–∞ –∏–∑ –ª–æ–≥–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const fileMatch = messageLower.match(/(\d+)\s+(—Ñ–∞–π–ª–æ–≤|files)/);
                if (fileMatch) {
                    agentState.totalFiles = parseInt(fileMatch[1]);
                }
                
                const successMatch = messageLower.match(/(\d+)\s+(—É—Å–ø–µ—à–Ω—ã—Ö|success)/);
                if (successMatch) {
                    agentState.successTests = parseInt(successMatch[1]);
                }
                
                const failedMatch = messageLower.match(/(\d+)\s+(–æ—à–∏–±–æ–∫|failed)/);
                if (failedMatch) {
                    agentState.failedTests = parseInt(failedMatch[1]);
                }
            });
            
            updateUI();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            if (agentState.active) {
                agentStatus.className = 'status-indicator status-active';
                agentStatus.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                agentStatus.className = 'status-indicator status-inactive';
                agentStatus.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('totalFiles').textContent = agentState.totalFiles;
            document.getElementById('successTests').textContent = agentState.successTests;
            document.getElementById('failedTests').textContent = agentState.failedTests;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
            let progress = 0;
            switch(agentState.currentStep) {
                case 'scanning':
                    progress = 25;
                    break;
                case 'processing':
                    progress = 50;
                    break;
                case 'generating':
                    progress = 75;
                    break;
                case 'uploading':
                    progress = 100;
                    break;
                default:
                    progress = 0;
            }
            
            // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            if (agentState.totalFiles > 0) {
                const fileProgress = Math.min(Math.round(((agentState.successTests + agentState.failedTests) / agentState.totalFiles) * 25), 25);
                progress = Math.min(progress + fileProgress, 100);
            }
            
            agentState.currentProgress = progress;
            progressFill.style.width = `${agentState.currentProgress}%`;
            progressPercent.textContent = `${agentState.currentProgress}%`;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        modelPathInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                modelFileName.textContent = this.files[0].name;
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞
                modelPathTextInput.value = '';
            } else {
                modelFileName.textContent = '';
            }
        });

        modelPathTextInput.addEventListener('input', function(e) {
            // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –∏–Ω–ø—É—Ç –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
            if (this.value) {
                modelPathInput.value = '';
                modelFileName.textContent = '';
            }
        });

        startBtn.addEventListener('click', startAgent);
        stopBtn.addEventListener('click', stopAgent);
        clearLogBtn.addEventListener('click', clearLog);
        exportLogBtn.addEventListener('click', exportLog);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('testsModal');
            if (event.target === modal) {
                closeTestsModal();
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–º
        async function startAgent() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
            let modelPath = '';
            
            if (modelPathInput.files.length > 0) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                modelPath = await uploadModelFile();
                if (!modelPath) return;
            } else if (modelPathTextInput.value) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
                modelPath = modelPathTextInput.value;
                addLogEntry(`INFO - üìÇ –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É—Ç—å: ${modelPath}`, 'info');
            } else {
                addLogEntry('ERROR - –û—à–∏–±–∫–∞: –ù–µ –≤—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å –ò–ò', 'error');
                return;
            }
            
            if (!scenarioRepoInput.value) {
                addLogEntry('ERROR - –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤', 'error');
                return;
            }
            
            if (!aftRepoInput.value) {
                addLogEntry('ERROR - –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π AFT', 'error');
                return;
            }
            
            try {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
                resetProgress();
                addLogEntry('INFO - –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞...', 'info');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç–∞ —Å –ø—É—Ç–µ–º –∫ —Ñ–∞–π–ª—É
                const response = await fetch(`${SERVER_URL}/api/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model_path: modelPath,
                        scenario_repo: scenarioRepoInput.value,
                        aft_repo: aftRepoInput.value,
                        scan_interval: parseInt(scanIntervalInput.value)
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    agentState.active = true;
                    updateUI();
                    addLogEntry('INFO - ‚úÖ –ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!', 'success');
                    // –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –ª–æ–≥–∏
                    startStatusPolling();
                    startLogPolling();
                } else {
                    addLogEntry(`ERROR - –û—à–∏–±–∫–∞: ${result.message}`, 'error');
                }
                
            } catch (error) {
                addLogEntry(`ERROR - –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                addLogEntry('WARNING - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'warning');
            }
        }

        async function uploadModelFile() {
            const file = modelPathInput.files[0];
            const formData = new FormData();
            formData.append('model', file);
            
            addLogEntry(`INFO - üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏: ${file.name}`, 'info');
            
            const uploadResponse = await fetch(`${SERVER_URL}/api/upload-model`, {
                method: 'POST',
                body: formData
            });
            
            const uploadResult = await uploadResponse.json();
            
            if (uploadResult.status !== 'success') {
                addLogEntry(`ERROR - ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${uploadResult.message}`, 'error');
                return null;
            }
            
            addLogEntry(`INFO - ‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${uploadResult.filename}`, 'success');
            return uploadResult.path;
        }

        async function stopAgent() {
            try {
                addLogEntry('INFO - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≥–µ–Ω—Ç–∞...', 'info');
                
                const response = await fetch(`${SERVER_URL}/api/stop`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    agentState.active = false;
                    updateUI();
                    addLogEntry('INFO - –ê–≥–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
                    stopPolling();
                }
                
            } catch (error) {
                addLogEntry(`ERROR - –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${error.message}`, 'error');
            }
        }

        // –û–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞
        function startStatusPolling() {
            statusPollInterval = setInterval(async () => {
                if (!agentState.active) {
                    clearInterval(statusPollInterval);
                    return;
                }
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/status`);
                    const status = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    if (status.status === 'stopped') {
                        agentState.active = false;
                        updateUI();
                        addLogEntry('INFO - –ê–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É', 'info');
                        stopPolling();
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞:', error);
                }
            }, 3000); // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        }

        // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function startLogPolling() {
            logUpdateInterval = setInterval(async () => {
                if (!agentState.active) {
                    clearInterval(logUpdateInterval);
                    return;
                }
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/status`);
                    const status = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏
                    if (status.logs && status.logs.length > 0) {
                        status.logs.forEach(log => {
                            addLogEntry(log.message, log.type);
                        });
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –ª–æ–≥–æ–≤
                    updateStatsFromLogs(status.logs);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ –ª–æ–≥–æ–≤:', error);
                }
            }, 1000); // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–æ–≥–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        }

        function stopPolling() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
                logUpdateInterval = null;
            }
        }

        function addLogEntry(message, type = 'info') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
            const existingEntries = activityLog.querySelectorAll('.log-entry');
            const lastEntry = existingEntries[existingEntries.length - 1];
            
            if (lastEntry && lastEntry.textContent.includes(message)) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'log-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = `log-${type}`;
            messageSpan.textContent = ` ${message}`;
            
            logEntry.appendChild(timestampSpan);
            logEntry.appendChild(messageSpan);
            
            activityLog.appendChild(logEntry);
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        function clearLog() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const firstEntry = activityLog.firstElementChild;
            activityLog.innerHTML = '';
            if (firstEntry) {
                activityLog.appendChild(firstEntry);
            }
            addLogEntry('INFO - –ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', 'info');
        }

        async function exportLog() {
            try {
                const response = await fetch(`${SERVER_URL}/api/logs`);
                const data = await response.json();
                
                let logContent = "=== –ñ—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç—ã Test Automation Agent ===\n";
                logContent += `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString()}\n`;
                logContent += "=============================================\n\n";
                
                data.logs.forEach(log => {
                    logContent += `${log.message}\n`;
                });
                
                const blob = new Blob([logContent], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `automation-agent-log-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addLogEntry('INFO - –ñ—É—Ä–Ω–∞–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
            } catch (error) {
                addLogEntry(`ERROR - –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∂—É—Ä–Ω–∞–ª–∞: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        resetProgress(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateUI();
        addLogEntry('INFO - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≥–µ–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω', 'info');
        addLogEntry(`INFO - –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –°–µ—Ä–≤–µ—Ä: ${SERVER_URL}`, 'success');
        addLogEntry('INFO - –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –ò–ò –∏ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏', 'info');
    </script>
</body>
</html>